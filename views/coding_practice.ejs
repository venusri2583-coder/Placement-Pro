<%- include('partials/header') %>

<div class="py-2 text-white mb-3 shadow-sm" style="background: #0f172a; border-bottom: 3px solid #38a169;">
    <div class="container d-flex justify-content-between align-items-center">
        <h6 class="mb-0 fw-bold" style="font-size: 0.85rem;"><%= topicName %> - Mastery</h6>
        <span class="badge bg-success rounded-pill px-3" style="font-size: 0.65rem;">Elite Portal</span>
    </div>
</div>

<div class="container mb-5">
    <div class="row justify-content-center">
        <div class="col-lg-11">
            <% if (questions && questions.length > 0) { %>
                <% questions.forEach((q, index) => { %>
                    <div class="card mb-3 border-0 shadow-sm rounded-3 overflow-hidden" style="border: 1px solid #e2e8f0 !important;">
                        <div class="card-body p-3">
                            <div class="q-anchor" style="text-align: left !important; display: block !important;">
                                <h6 class="text-dark fw-bold mb-2" style="font-size: 0.95rem; line-height: 1.4;">
                                    <%= index + 1 %>. <%= q.question_text %>
                                </h6>
                                <% if (q.code_snippet) { %>
                                    <pre class="bg-dark text-success p-2 rounded-2 mb-2" style="font-size: 0.8rem; text-align: left !important;"><%= q.code_snippet %></pre>
                                <% } %>
                            </div>
                            
                            <div class="row g-2 options-row">
                                <% ['a', 'b', 'c', 'd'].forEach(opt => { %>
                                    <div class="col-md-6">
                                        <div class="option-tile p-2 border rounded-2 d-flex align-items-center" 
                                             id="tile-<%= q.id %>-<%= opt %>"
                                             style="cursor: pointer; transition: 0.2s; font-size: 0.85rem; background: #f8fafc;"
                                             onclick="checkAns(this, '<%= opt %>', '<%= q.correct_option %>', '<%= q.id %>')">
                                            <div class="me-2 fw-bold text-primary"><%= opt.toUpperCase() %>)</div>
                                            <div class="text-dark"><%= q['option_' + opt] %></div>
                                            <i class="fas fa-check-circle ms-auto d-none text-success small"></i>
                                            <i class="fas fa-times-circle ms-auto d-none text-danger small"></i>
                                        </div>
                                    </div>
                                <% }) %>
                            </div>

                            <div class="mt-2 border-top pt-2 d-flex justify-content-between align-items-center">
                                <div id="msg-<%= q.id %>" class="small fw-bold"></div>
                                <button class="btn btn-sm btn-outline-primary rounded-pill px-3 d-none" 
                                        id="btn-<%= q.id %>"
                                        onclick="document.getElementById('sol-<%= q.id %>').classList.toggle('d-none')">
                                    <i class="fas fa-brain me-1"></i> Unlock Logic Map
                                </button>
                            </div>

                            <div class="mt-2 d-none animate__animated animate__fadeIn" id="sol-<%= q.id %>">
                                <div class="p-3 rounded-3 shadow-sm" style="background: #f0f9ff; border: 1px solid #bae6fd; font-size: 0.85rem;">
                                    <span class="badge bg-primary mb-2">Answer: <%= q.correct_option.toUpperCase() %></span>
                                    <div class="text-secondary"><%- q.explanation %></div>
                                </div>
                            </div>
                        </div>
                    </div>
                <% }) %>

                <div class="text-center mt-5 mb-5 pb-5">
                    <button class="btn btn-dark rounded-pill px-5 py-2 fw-bold shadow-lg" onclick="finishSession()">
                        Submit Practice Session
                    </button>
                </div>

            <% } %>
        </div>
    </div>
</div>

<style>
    .q-anchor, .q-anchor h6, .q-anchor pre { text-align: left !important; margin-left: 0 !important; }
    .option-tile:hover { border-color: #38a169; background: #fff; }
    .option-tile.correct { background: #dcfce7 !important; border-color: #16a34a !important; }
    .option-tile.wrong { background: #fee2e2 !important; border-color: #dc2626 !important; }
</style>

<script>
let userScore = 0;
const totalQ = <%= questions.length %>;

function checkAns(el, selected, correct, qId) {
    const parent = el.closest('.options-row');
    parent.querySelectorAll('.option-tile').forEach(t => { t.style.pointerEvents = 'none'; t.style.opacity = '0.7'; });
    el.style.opacity = '1';

    if (selected === correct) {
        userScore++;
        el.classList.add('correct');
        el.querySelector('.fa-check-circle').classList.remove('d-none');
        document.getElementById('msg-' + qId).innerHTML = '<span class="text-success small">Correct!</span>';
    } else {
        el.classList.add('wrong');
        el.querySelector('.fa-times-circle').classList.remove('d-none');
        document.getElementById('tile-' + qId + '-' + correct).classList.add('correct');
        document.getElementById('msg-' + qId).innerHTML = '<span class="text-danger small">Incorrect.</span>';
    }
    document.getElementById('btn-' + qId).classList.remove('d-none');
}

function finishSession() {
    alert("Practice Session Submitted!\nYour Score: " + userScore + " out of " + totalQ);
    window.location.href = "/coding";
}
</script>
<%- include('partials/footer') %>